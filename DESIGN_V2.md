# å®¶åº­AIåŠ©æ‰‹ V2.0 ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## ä¸€ã€è®¾è®¡æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

åŸºäºç°æœ‰ family-ai-app é¡¹ç›®è¿›è¡Œé‡æ–°è®¾è®¡ï¼Œæ–°å¢**å›¾ç‰‡é™„ä»¶ä¸Šä¼ **åŠŸèƒ½ï¼Œæ”¯æŒ Claude Vision è¿›è¡Œå›¾åƒåˆ†æã€‚

### 1.2 è®¾è®¡ç›®æ ‡

| ç›®æ ‡ | æè¿° |
|------|------|
| æ–°å¢åŠŸèƒ½ | å›¾ç‰‡ä¸Šä¼  + AIè§†è§‰åˆ†æ |
| å­˜å‚¨æ–¹æ¡ˆ | æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ |
| æ”¯æŒæ ¼å¼ | PNG, JPG, JPEG, GIF, WebP |
| æ–‡ä»¶é™åˆ¶ | å•æ–‡ä»¶æœ€å¤§ 10MB |
| ç”¨æˆ·ä½“éªŒ | æ‹–æ‹½ä¸Šä¼ ã€ç²˜è´´ä¸Šä¼ ã€ç‚¹å‡»ä¸Šä¼  |

---

## äºŒã€ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯ (Next.js)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Sidebar     â”‚  â”‚  ChatArea     â”‚  â”‚   ChatInput       â”‚   â”‚
â”‚  â”‚  (ä¼šè¯ç®¡ç†)   â”‚  â”‚ (æ¶ˆæ¯å±•ç¤º)    â”‚  â”‚  (è¾“å…¥+ä¸Šä¼ )      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                    â”‚             â”‚
â”‚                              â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                              â”‚         â”‚  ImageUploader      â”‚  â”‚
â”‚                              â”‚         â”‚  (å›¾ç‰‡ä¸Šä¼ ç»„ä»¶)     â”‚  â”‚
â”‚                              â”‚         â”‚  - æ‹–æ‹½ä¸Šä¼          â”‚  â”‚
â”‚                              â”‚         â”‚  - ç²˜è´´ä¸Šä¼          â”‚  â”‚
â”‚                              â”‚         â”‚  - ç‚¹å‡»é€‰æ‹©         â”‚  â”‚
â”‚                              â”‚         â”‚  - é¢„è§ˆç¼©ç•¥å›¾       â”‚  â”‚
â”‚                              â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API è·¯ç”±å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ /api/chat   â”‚  â”‚ /api/image  â”‚  â”‚ /api/upload            â”‚ â”‚
â”‚  â”‚ (å¯¹è¯)      â”‚  â”‚ (ç”Ÿæˆå›¾ç‰‡) â”‚  â”‚ (ä¸Šä¼ é™„ä»¶) [NEW]       â”‚ â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚ - éªŒè¯æ–‡ä»¶ç±»å‹         â”‚ â”‚
â”‚  â”‚ Claude API  â”‚  â”‚ Gemini API  â”‚  â”‚ - ä¿å­˜åˆ°æœ¬åœ°           â”‚ â”‚
â”‚  â”‚ (å«Vision)  â”‚  â”‚             â”‚  â”‚ - è¿”å›æ–‡ä»¶URL          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å­˜å‚¨å±‚                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  LocalStorage       â”‚  â”‚  æ–‡ä»¶ç³»ç»Ÿ (æœ¬åœ°å­˜å‚¨)              â”‚ â”‚
â”‚  â”‚  - ä¼šè¯æ•°æ®         â”‚  â”‚  /public/uploads/                 â”‚ â”‚
â”‚  â”‚  - è®¤è¯çŠ¶æ€         â”‚  â”‚  â”œâ”€â”€ 2024/                        â”‚ â”‚
â”‚  â”‚                     â”‚  â”‚  â”‚   â”œâ”€â”€ 12/                      â”‚ â”‚
â”‚  â”‚                     â”‚  â”‚  â”‚   â”‚   â”œâ”€â”€ {uuid}.jpg          â”‚ â”‚
â”‚  â”‚                     â”‚  â”‚  â”‚   â”‚   â””â”€â”€ {uuid}.png          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµå›¾

```
å›¾ç‰‡ä¸Šä¼ æµç¨‹:

ç”¨æˆ·é€‰æ‹©å›¾ç‰‡
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯éªŒè¯        â”‚
â”‚ - æ–‡ä»¶ç±»å‹      â”‚
â”‚ - æ–‡ä»¶å¤§å°      â”‚
â”‚ - æ•°é‡é™åˆ¶      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/uploadâ”‚
â”‚ FormData       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç«¯å¤„ç†        â”‚
â”‚ - ç”ŸæˆUUID      â”‚
â”‚ - ä¿å­˜æ–‡ä»¶      â”‚
â”‚ - è¿”å›URL       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ˜¾ç¤ºé¢„è§ˆ        â”‚
â”‚ - ç¼©ç•¥å›¾        â”‚
â”‚ - åˆ é™¤æŒ‰é’®      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
å‘é€æ¶ˆæ¯æ—¶æºå¸¦å›¾ç‰‡URL
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Claude Vision   â”‚
â”‚ å›¾åƒåˆ†æ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 ç±»å‹å®šä¹‰æ‰©å±•

```typescript
// src/lib/types.ts

// é™„ä»¶ç±»å‹
export interface Attachment {
  id: string           // UUID
  type: 'image'        // é™„ä»¶ç±»å‹
  filename: string     // åŸå§‹æ–‡ä»¶å
  url: string          // è®¿é—®URL
  mimeType: string     // MIMEç±»å‹
  size: number         // æ–‡ä»¶å¤§å°(bytes)
  width?: number       // å›¾ç‰‡å®½åº¦
  height?: number      // å›¾ç‰‡é«˜åº¦
  uploadedAt: number   // ä¸Šä¼ æ—¶é—´æˆ³
}

// æ¶ˆæ¯ç±»å‹ (æ‰©å±•)
export interface Message {
  id: string
  role: 'user' | 'assistant'
  content: string
  timestamp: number
  imageUrl?: string           // ç”Ÿæˆçš„å›¾ç‰‡ (ä¿ç•™)
  attachments?: Attachment[]  // ä¸Šä¼ çš„é™„ä»¶ [NEW]
}

// ä¸Šä¼ å“åº”
export interface UploadResponse {
  success: boolean
  attachment?: Attachment
  error?: string
}

// èŠå¤©è¯·æ±‚ (æ‰©å±•)
export interface ChatRequest {
  messages: Array<{
    role: 'user' | 'assistant'
    content: string | ContentBlock[]  // æ”¯æŒå¤šæ¨¡æ€å†…å®¹
  }>
}

// å¤šæ¨¡æ€å†…å®¹å—
export type ContentBlock =
  | { type: 'text'; text: string }
  | { type: 'image'; source: ImageSource }

export interface ImageSource {
  type: 'base64' | 'url'
  media_type: string
  data?: string  // base64æ•°æ®
  url?: string   // å›¾ç‰‡URL
}
```

### 3.2 æ–‡ä»¶å­˜å‚¨ç»“æ„

```
public/
â””â”€â”€ uploads/
    â””â”€â”€ {year}/
        â””â”€â”€ {month}/
            â”œâ”€â”€ {uuid}.{ext}
            â”œâ”€â”€ {uuid}.{ext}
            â””â”€â”€ ...

ç¤ºä¾‹:
public/uploads/2024/12/550e8400-e29b-41d4-a716-446655440000.jpg
è®¿é—®URL: /uploads/2024/12/550e8400-e29b-41d4-a716-446655440000.jpg
```

---

## å››ã€API è®¾è®¡

### 4.1 æ–°å¢ - æ–‡ä»¶ä¸Šä¼ æ¥å£

**ç«¯ç‚¹**: `POST /api/upload`

**è¯·æ±‚**:
```
Content-Type: multipart/form-data

FormData:
  - file: File (å›¾ç‰‡æ–‡ä»¶)
```

**å“åº”**:
```json
// æˆåŠŸ
{
  "success": true,
  "attachment": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "type": "image",
    "filename": "photo.jpg",
    "url": "/uploads/2024/12/550e8400-e29b-41d4-a716-446655440000.jpg",
    "mimeType": "image/jpeg",
    "size": 102400,
    "width": 1920,
    "height": 1080,
    "uploadedAt": 1702234567890
  }
}

// å¤±è´¥
{
  "success": false,
  "error": "æ–‡ä»¶ç±»å‹ä¸æ”¯æŒ"
}
```

**éªŒè¯è§„åˆ™**:
| è§„åˆ™ | å€¼ |
|------|------|
| å…è®¸ç±»å‹ | image/png, image/jpeg, image/gif, image/webp |
| æœ€å¤§å¤§å° | 10MB |
| æœ€å¤§æ•°é‡ | æ¯æ¬¡è¯·æ±‚1ä¸ªæ–‡ä»¶ |

### 4.2 æ–°å¢ - å›¾ç‰‡åˆ†ææ¥å£

**ç«¯ç‚¹**: `POST /api/analyze`

**è¯·æ±‚**:
```json
{
  "prompt": "è¿™å¼ å›¾ç‰‡æ˜¯ä»€ä¹ˆ?",
  "imageUrl": "/uploads/2024/12/xxx.jpg"
}
```

**å“åº”**:
```json
// æˆåŠŸ
{
  "success": true,
  "text": "è¿™æ˜¯ä¸€åªå¯çˆ±çš„æŸ´çŠ¬ï¼Œå®ƒæ­£åœ¨è‰åœ°ä¸Šå¥”è·‘..."
}

// å¤±è´¥
{
  "success": false,
  "error": "åˆ†æå¤±è´¥"
}
```

**å¤„ç†é€»è¾‘**:
1. è¯»å–æœ¬åœ°å›¾ç‰‡æ–‡ä»¶
2. è½¬æ¢ä¸º base64 æ ¼å¼
3. è°ƒç”¨ Gemini Vision API
4. è¿”å›åˆ†æç»“æœæ–‡æœ¬

### 4.3 èŠå¤©æ¥å£ (ä¿æŒä¸å˜)

**ç«¯ç‚¹**: `POST /api/chat` - çº¯æ–‡æœ¬å¯¹è¯ï¼Œç»§ç»­ä½¿ç”¨ Claude API

---

## äº”ã€ç»„ä»¶è®¾è®¡

### 5.1 æ–°å¢ç»„ä»¶ - ImageUploader

**æ–‡ä»¶**: `src/components/ImageUploader.tsx`

**åŠŸèƒ½**:
- æ‹–æ‹½ä¸Šä¼  (Drag & Drop)
- ç²˜è´´ä¸Šä¼  (Ctrl+V)
- ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
- é¢„è§ˆç¼©ç•¥å›¾
- åˆ é™¤å·²é€‰å›¾ç‰‡
- ä¸Šä¼ è¿›åº¦æ˜¾ç¤º

**Props**:
```typescript
interface ImageUploaderProps {
  onUpload: (attachment: Attachment) => void
  onRemove: (id: string) => void
  attachments: Attachment[]
  disabled?: boolean
  maxFiles?: number
}
```

**çŠ¶æ€**:
```typescript
{
  isDragging: boolean      // æ‹–æ‹½çŠ¶æ€
  isUploading: boolean     // ä¸Šä¼ ä¸­
  uploadProgress: number   // ä¸Šä¼ è¿›åº¦ 0-100
  error: string | null     // é”™è¯¯ä¿¡æ¯
}
```

**UI ç»“æ„**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     æ‹–æ‹½åŒºåŸŸ / ç‚¹å‡»ä¸Šä¼                 â”‚   â”‚
â”‚  â”‚     ğŸ“ ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ            â”‚   â”‚
â”‚  â”‚     æ”¯æŒ PNG, JPG, GIF, WebP           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                â”‚
â”‚  å·²é€‰å›¾ç‰‡é¢„è§ˆ:                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ [img] â”‚ â”‚ [img] â”‚ â”‚ [img] â”‚                â”‚
â”‚  â”‚   Ã—   â”‚ â”‚   Ã—   â”‚ â”‚   Ã—   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ä¿®æ”¹ç»„ä»¶ - ChatInput

**æ–‡ä»¶**: `src/components/ChatInput.tsx`

**æ–°å¢åŠŸèƒ½**:
- é›†æˆ ImageUploader
- é™„ä»¶æŒ‰é’® (ğŸ“)
- å›¾ç‰‡é¢„è§ˆåŒº
- æ”¯æŒå¸¦é™„ä»¶å‘é€

**ä¿®æ”¹åç»“æ„**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [å›¾ç‰‡é¢„è§ˆåŒº - å¦‚æœ‰å·²ä¸Šä¼ å›¾ç‰‡åˆ™æ˜¾ç¤º]                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚ [img] â”‚ â”‚ [img] â”‚                                    â”‚
â”‚  â”‚   Ã—   â”‚ â”‚   Ã—   â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚                                                      â”‚â”‚
â”‚ â”‚              æ–‡æœ¬è¾“å…¥æ¡†                              â”‚â”‚
â”‚ â”‚                                                      â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚ [ğŸ“ é™„ä»¶] [ğŸ’¬/ğŸ¨ æ¨¡å¼åˆ‡æ¢]                    [â¤ å‘é€] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 ä¿®æ”¹ç»„ä»¶ - ChatMessage

**æ–‡ä»¶**: `src/components/ChatMessage.tsx`

**æ–°å¢åŠŸèƒ½**:
- æ˜¾ç¤ºæ¶ˆæ¯ä¸­çš„é™„ä»¶å›¾ç‰‡
- å›¾ç‰‡ç‚¹å‡»æ”¾å¤§æŸ¥çœ‹
- å›¾ç‰‡ç”»å»Šæ¨¡å¼

**é™„ä»¶å±•ç¤º**:
```
ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿™å¼ å›¾ç‰‡æ˜¯ä»€ä¹ˆåŠ¨ç‰©?           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  [img]  â”‚  â† ä¸Šä¼ çš„å›¾ç‰‡    â”‚
â”‚  â”‚ ç‚¹å‡»æ”¾å¤§ â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŠ©æ‰‹æ¶ˆæ¯æ°”æ³¡:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿™æ˜¯ä¸€åªå¯çˆ±çš„æŸ´çŠ¬ï¼å®ƒæ­£åœ¨...  â”‚
â”‚  (Markdown æ¸²æŸ“çš„å›å¤)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€ç›®å½•ç»“æ„ (æ”¹è¿›å)

```
family-ai-app/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts        # å¯¹è¯API (ä¿®æ”¹: æ”¯æŒVision)
â”‚   â”‚   â”‚   â”œâ”€â”€ image/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts        # å›¾ç‰‡ç”ŸæˆAPI
â”‚   â”‚   â”‚   â””â”€â”€ upload/
â”‚   â”‚   â”‚       â””â”€â”€ route.ts        # [NEW] æ–‡ä»¶ä¸Šä¼ API
â”‚   â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”‚   â”œâ”€â”€ page.tsx                # ä¸»é¡µé¢ (ä¿®æ”¹: æ”¯æŒé™„ä»¶)
â”‚   â”‚   â””â”€â”€ globals.css             # å…¨å±€æ ·å¼ (ä¿®æ”¹: æ–°å¢ä¸Šä¼ ç»„ä»¶æ ·å¼)
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ ChatInput.tsx           # è¾“å…¥ç»„ä»¶ (ä¿®æ”¹: é›†æˆä¸Šä¼ )
â”‚   â”‚   â”œâ”€â”€ ChatMessage.tsx         # æ¶ˆæ¯ç»„ä»¶ (ä¿®æ”¹: æ˜¾ç¤ºé™„ä»¶)
â”‚   â”‚   â”œâ”€â”€ Sidebar.tsx
â”‚   â”‚   â”œâ”€â”€ ImageUploader.tsx       # [NEW] å›¾ç‰‡ä¸Šä¼ ç»„ä»¶
â”‚   â”‚   â””â”€â”€ ImageModal.tsx          # [NEW] å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡†
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ types.ts                # ç±»å‹å®šä¹‰ (ä¿®æ”¹: æ–°å¢Attachment)
â”‚   â”‚   â”œâ”€â”€ storage.ts
â”‚   â”‚   â””â”€â”€ upload.ts               # [NEW] ä¸Šä¼ å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ hooks/
â”‚       â””â”€â”€ useImageUpload.ts       # [NEW] ä¸Šä¼ Hook
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ uploads/                    # [NEW] ä¸Šä¼ æ–‡ä»¶å­˜å‚¨ç›®å½•
â”‚   â”‚   â””â”€â”€ .gitkeep
â”‚   â”œâ”€â”€ manifest.json
â”‚   â””â”€â”€ icon-*.png
â””â”€â”€ ... (é…ç½®æ–‡ä»¶)
```

---

## ä¸ƒã€å…³é”®å®ç°ç»†èŠ‚

### 7.1 Gemini 3 Pro Image (Banana Pro) ç»Ÿä¸€é›†æˆ

**è®¾è®¡ç†å¿µ**: å›¾ç‰‡ç›¸å…³åŠŸèƒ½å…¨éƒ¨ä½¿ç”¨ **Banana Pro** (gemini-3-pro-image-preview)
- ğŸ¨ å›¾ç‰‡ç”Ÿæˆ â†’ Banana Pro
- ğŸ” å›¾ç‰‡åˆ†æ â†’ Banana Pro (ç»§æ‰¿ Gemini 3 Pro çš„è§†è§‰æ¨ç†èƒ½åŠ›)

**ä¼˜åŠ¿**:
- ç»Ÿä¸€æ¨¡å‹ï¼Œç®€åŒ–æ¶æ„
- Banana Pro åŸºäº Gemini 3 Pro æ„å»ºï¼Œå…·å¤‡å¼ºå¤§çš„è§†è§‰ç†è§£èƒ½åŠ›
- åŒæ—¶æ”¯æŒç”Ÿæˆå’Œç†è§£ï¼Œä¸€ä¸ªæ¨¡å‹æå®šæ‰€æœ‰å›¾ç‰‡éœ€æ±‚

```typescript
// src/app/api/analyze/route.ts (æ–°å¢ - å›¾ç‰‡åˆ†æ)

import { NextRequest } from 'next/server'
import { HttpsProxyAgent } from 'https-proxy-agent'
import fs from 'fs'
import path from 'path'

const GEMINI_API_KEY = process.env.GEMINI_API_KEY || ''
const PROXY_URL = process.env.HTTPS_PROXY || 'http://192.168.50.2:7890'

export async function POST(request: NextRequest) {
  try {
    const { prompt, imageUrl } = await request.json()

    // è¯»å–æœ¬åœ°å›¾ç‰‡è½¬ä¸º base64
    const filePath = path.join(process.cwd(), 'public', imageUrl)
    const imageBuffer = fs.readFileSync(filePath)
    const base64Image = imageBuffer.toString('base64')

    // è·å– MIME ç±»å‹
    const ext = imageUrl.split('.').pop()?.toLowerCase()
    const mimeType = {
      'jpg': 'image/jpeg',
      'jpeg': 'image/jpeg',
      'png': 'image/png',
      'gif': 'image/gif',
      'webp': 'image/webp'
    }[ext] || 'image/jpeg'

    const proxyAgent = new HttpsProxyAgent(PROXY_URL)
    const nodeFetch = (await import('node-fetch')).default

    // ä½¿ç”¨ Banana Pro (Gemini 3 Pro Image) - åŒæ—¶æ”¯æŒç”Ÿæˆå’Œç†è§£
    const model = 'gemini-3-pro-image-preview'
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`

    const response = await nodeFetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [
            { text: prompt || 'è¯·ç”¨ä¸­æ–‡è¯¦ç»†æè¿°è¿™å¼ å›¾ç‰‡çš„å†…å®¹' },
            {
              inlineData: {
                mimeType,
                data: base64Image
              }
            }
          ]
        }],
        generationConfig: {
          temperature: 0.7,
          maxOutputTokens: 2048
        }
      }),
      agent: proxyAgent,
    })

    if (response.ok) {
      const data = await response.json() as any
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text
      return Response.json({ success: true, text })
    }

    return Response.json({ success: false, error: 'åˆ†æå¤±è´¥' })
  } catch (error: any) {
    console.error('Analyze error:', error)
    return Response.json({ success: false, error: error.message })
  }
}
```

### 7.2 æ–‡ä»¶ä¸Šä¼ å¤„ç†

```typescript
// src/app/api/upload/route.ts

import { NextRequest, NextResponse } from 'next/server'
import { writeFile, mkdir } from 'fs/promises'
import path from 'path'
import { v4 as uuidv4 } from 'uuid'

const ALLOWED_TYPES = ['image/png', 'image/jpeg', 'image/gif', 'image/webp']
const MAX_SIZE = 10 * 1024 * 1024 // 10MB

export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData()
    const file = formData.get('file') as File

    // éªŒè¯
    if (!file) {
      return NextResponse.json({ success: false, error: 'è¯·é€‰æ‹©æ–‡ä»¶' })
    }

    if (!ALLOWED_TYPES.includes(file.type)) {
      return NextResponse.json({ success: false, error: 'ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹' })
    }

    if (file.size > MAX_SIZE) {
      return NextResponse.json({ success: false, error: 'æ–‡ä»¶è¿‡å¤§(æœ€å¤§10MB)' })
    }

    // ç”Ÿæˆå­˜å‚¨è·¯å¾„
    const now = new Date()
    const year = now.getFullYear()
    const month = String(now.getMonth() + 1).padStart(2, '0')
    const ext = file.name.split('.').pop()
    const uuid = uuidv4()
    const filename = `${uuid}.${ext}`

    const uploadDir = path.join(process.cwd(), 'public', 'uploads', String(year), month)
    await mkdir(uploadDir, { recursive: true })

    const filePath = path.join(uploadDir, filename)
    const buffer = Buffer.from(await file.arrayBuffer())
    await writeFile(filePath, buffer)

    // è¿”å›ç»“æœ
    const url = `/uploads/${year}/${month}/${filename}`

    return NextResponse.json({
      success: true,
      attachment: {
        id: uuid,
        type: 'image',
        filename: file.name,
        url,
        mimeType: file.type,
        size: file.size,
        uploadedAt: Date.now()
      }
    })

  } catch (error) {
    console.error('Upload error:', error)
    return NextResponse.json({ success: false, error: 'ä¸Šä¼ å¤±è´¥' })
  }
}
```

### 7.3 æ‹–æ‹½ä¸Šä¼ å®ç°

```typescript
// src/hooks/useImageUpload.ts

import { useState, useCallback } from 'react'
import { Attachment } from '@/lib/types'

export function useImageUpload() {
  const [isUploading, setIsUploading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const upload = useCallback(async (file: File): Promise<Attachment | null> => {
    setIsUploading(true)
    setError(null)

    try {
      const formData = new FormData()
      formData.append('file', file)

      const response = await fetch('/api/upload', {
        method: 'POST',
        body: formData
      })

      const result = await response.json()

      if (result.success) {
        return result.attachment
      } else {
        setError(result.error)
        return null
      }
    } catch (err) {
      setError('ä¸Šä¼ å¤±è´¥')
      return null
    } finally {
      setIsUploading(false)
    }
  }, [])

  return { upload, isUploading, error }
}
```

---

## å…«ã€UI/UX è®¾è®¡

### 8.1 äº¤äº’æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡» ğŸ“ æŒ‰é’®æˆ–æ‹–æ‹½å›¾ç‰‡
         â”‚
         â–¼
2. æ˜¾ç¤ºæ‹–æ‹½åŒºåŸŸ/æ–‡ä»¶é€‰æ‹©å™¨
         â”‚
         â–¼
3. é€‰æ‹©å›¾ç‰‡åç«‹å³ä¸Šä¼ 
         â”‚
         â–¼
4. æ˜¾ç¤ºä¸Šä¼ è¿›åº¦ (0-100%)
         â”‚
         â–¼
5. ä¸Šä¼ æˆåŠŸ â†’ æ˜¾ç¤ºç¼©ç•¥å›¾é¢„è§ˆ
   ä¸Šä¼ å¤±è´¥ â†’ æ˜¾ç¤ºé”™è¯¯æç¤º
         â”‚
         â–¼
6. ç”¨æˆ·å¯åˆ é™¤å·²ä¸Šä¼ å›¾ç‰‡ (ç‚¹å‡»Ã—)
         â”‚
         â–¼
7. è¾“å…¥æ–‡æœ¬ + ç‚¹å‡»å‘é€
         â”‚
         â–¼
8. æ¶ˆæ¯ä¸­æ˜¾ç¤ºå›¾ç‰‡ + æ–‡æœ¬
         â”‚
         â–¼
9. AIåˆ†æå›¾ç‰‡å¹¶å›å¤
```

### 8.2 æ ·å¼è®¾è®¡

```css
/* æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ */
.upload-zone {
  border: 2px dashed #cbd5e1;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  transition: all 0.2s;
}

.upload-zone.dragging {
  border-color: #0ea5e9;
  background: #f0f9ff;
}

/* å›¾ç‰‡é¢„è§ˆ */
.preview-item {
  position: relative;
  width: 80px;
  height: 80px;
  border-radius: 8px;
  overflow: hidden;
}

.preview-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.preview-item .remove-btn {
  position: absolute;
  top: 4px;
  right: 4px;
  width: 20px;
  height: 20px;
  background: rgba(0, 0, 0, 0.5);
  border-radius: 50%;
  color: white;
}

/* ä¸Šä¼ è¿›åº¦ */
.upload-progress {
  height: 4px;
  background: #e2e8f0;
  border-radius: 2px;
  overflow: hidden;
}

.upload-progress .bar {
  height: 100%;
  background: #0ea5e9;
  transition: width 0.3s;
}
```

---

## ä¹ã€å®‰å…¨è€ƒè™‘

### 9.1 æ–‡ä»¶ä¸Šä¼ å®‰å…¨

| é£é™© | é˜²æŠ¤æªæ–½ |
|------|---------|
| æ¶æ„æ–‡ä»¶ä¸Šä¼  | ç™½åå•éªŒè¯ MIME ç±»å‹ |
| æ–‡ä»¶å¤§å°æ”»å‡» | é™åˆ¶æœ€å¤§ 10MB |
| è·¯å¾„éå† | UUID é‡å‘½åï¼Œä¸ä½¿ç”¨åŸæ–‡ä»¶å |
| æ–‡ä»¶ç±»å‹ä¼ªé€  | æ ¡éªŒæ–‡ä»¶é­”æ•° (Magic Number) |
| å­˜å‚¨ç©ºé—´è€—å°½ | å®šæœŸæ¸…ç†è¿‡æœŸæ–‡ä»¶ |

### 9.2 å®ç°å»ºè®®

```typescript
// éªŒè¯æ–‡ä»¶é­”æ•°
const FILE_SIGNATURES = {
  'image/png': [0x89, 0x50, 0x4E, 0x47],
  'image/jpeg': [0xFF, 0xD8, 0xFF],
  'image/gif': [0x47, 0x49, 0x46],
  'image/webp': [0x52, 0x49, 0x46, 0x46]
}

function validateMagicNumber(buffer: Buffer, mimeType: string): boolean {
  const signature = FILE_SIGNATURES[mimeType]
  if (!signature) return false

  for (let i = 0; i < signature.length; i++) {
    if (buffer[i] !== signature[i]) return false
  }
  return true
}
```

---

## åã€éƒ¨ç½²æ›´æ–°

### 10.1 Docker é…ç½®æ›´æ–°

```dockerfile
# Dockerfile æ–°å¢
# åˆ›å»ºä¸Šä¼ ç›®å½•
RUN mkdir -p /app/public/uploads && chown -R nextjs:nodejs /app/public/uploads

# æŒ‚è½½å· (æŒä¹…åŒ–ä¸Šä¼ æ–‡ä»¶)
VOLUME ["/app/public/uploads"]
```

### 10.2 docker-compose.yml æ›´æ–°

```yaml
services:
  family-ai:
    volumes:
      - uploads_data:/app/public/uploads

volumes:
  uploads_data:
```

---

## åä¸€ã€å®ç°ä¼˜å…ˆçº§

### é˜¶æ®µä¸€: æ ¸å¿ƒåŠŸèƒ½ (å¿…é¡»)
1. âœ… æ–‡ä»¶ä¸Šä¼  API
2. âœ… ImageUploader ç»„ä»¶
3. âœ… ChatInput é›†æˆä¸Šä¼ 
4. âœ… Claude Vision é›†æˆ

### é˜¶æ®µäºŒ: ä½“éªŒä¼˜åŒ– (æ¨è)
1. æ‹–æ‹½ä¸Šä¼ æ”¯æŒ
2. ç²˜è´´ä¸Šä¼ æ”¯æŒ
3. ä¸Šä¼ è¿›åº¦æ˜¾ç¤º
4. å›¾ç‰‡å‹ç¼©ä¼˜åŒ–

### é˜¶æ®µä¸‰: å¢å¼ºåŠŸèƒ½ (å¯é€‰)
1. å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡†
2. å¤šå›¾ä¸Šä¼ æ”¯æŒ
3. å›¾ç‰‡ç”»å»Šæ¨¡å¼
4. æ–‡ä»¶æ¸…ç†æœºåˆ¶

---

## åäºŒã€æ€»ç»“

æœ¬è®¾è®¡æ–‡æ¡£è¯¦ç»†è§„åˆ’äº†å®¶åº­AIåŠ©æ‰‹ V2.0 çš„å›¾ç‰‡é™„ä»¶ä¸Šä¼ åŠŸèƒ½ï¼ŒåŒ…æ‹¬:

- **æ¶æ„è®¾è®¡**: æ¸…æ™°çš„å‰åç«¯åˆ†å±‚æ¶æ„
- **æ•°æ®æ¨¡å‹**: æ‰©å±•çš„ç±»å‹å®šä¹‰å’Œå­˜å‚¨ç»“æ„
- **APIè®¾è®¡**: æ–°å¢ä¸Šä¼ æ¥å£ï¼Œä¿®æ”¹èŠå¤©æ¥å£æ”¯æŒVision
- **ç»„ä»¶è®¾è®¡**: æ–°å¢ImageUploaderï¼Œä¿®æ”¹ChatInputå’ŒChatMessage
- **å®‰å…¨è€ƒè™‘**: æ–‡ä»¶éªŒè¯ã€å¤§å°é™åˆ¶ã€å®‰å…¨å­˜å‚¨
- **éƒ¨ç½²é…ç½®**: Dockerå·æŒä¹…åŒ–

ä¸‹ä¸€æ­¥: ä½¿ç”¨ `/implement` å‘½ä»¤å¼€å§‹å®ç°ã€‚
